pipeline {
    agent any
    
    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION    = 'eu-west-1'
        SSH_KEY               = credentials('aws-private-key') 
        
        // Backend configuration
        PYTHON_PORT = "9000"
        JAVA_PORT   = "8080"
        APP_REPO    = "https://github.com/jidavy/fruits-veg_market.git"
    }
    
    stages {
        stage('Checkout Infrastructure Code') {
            steps {
                // This ensures the pipeline has access to the latest scripts in class2026
                checkout scm
            }
        }
        
        stage('Find Node IPs') {
            steps {
                script {
                    env.WEB_IP = sh(script: "aws ec2 describe-instances --filters 'Name=tag:Name,Values=web-node-frontend' 'Name=instance-state-name,Values=running' --query 'Reservations[*].Instances[*].PublicIpAddress' --output text", returnStdout: true).trim()
                    env.PYTHON_IP = sh(script: "aws ec2 describe-instances --filters 'Name=tag:Name,Values=python-node-backend' 'Name=instance-state-name,Values=running' --query 'Reservations[*].Instances[*].PublicIpAddress' --output text", returnStdout: true).trim()
                    env.JAVA_IP = sh(script: "aws ec2 describe-instances --filters 'Name=tag:Name,Values=java-node-backend' 'Name=instance-state-name,Values=running' --query 'Reservations[*].Instances[*].PublicIpAddress' --output text", returnStdout: true).trim()
                    
                    echo "Infrastructure Discovered:"
                    echo "Web: ${env.WEB_IP} | Python: ${env.PYTHON_IP} | Java: ${env.JAVA_IP}"
                }
            }
        }
        
        stage('Deploy Python Backend') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ec2-user@${env.PYTHON_IP} '
                    sudo yum install git python3-pip -y
                    rm -rf ~/fruits-veg_market
                    git clone ${env.APP_REPO} ~/fruits-veg_market
                    cd ~/fruits-veg_market/python
                    
                    python3 -m venv .venv
                    source .venv/bin/activate
                    pip install -r requirements.txt
                    
                    # Create service file in /tmp to avoid permission redirection issues
                    cat <<EOF > /tmp/fruits.service
[Unit]
Description=FastAPI Fruits Service
After=network.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
WorkingDirectory=/home/ec2-user/fruits-veg_market/python
Environment="PATH=/home/ec2-user/fruits-veg_market/python/.venv/bin"
ExecStart=/home/ec2-user/fruits-veg_market/python/.venv/bin/uvicorn main:app --host 0.0.0.0 --port ${env.PYTHON_PORT}
Restart=always

[Install]
WantedBy=multi-user.target
EOF
                    sudo mv /tmp/fruits.service /etc/systemd/system/fruits.service
                    sudo systemctl daemon-reload
                    sudo systemctl enable fruits.service
                    sudo systemctl restart fruits.service
                    
                    sleep 5
                    sudo systemctl is-active fruits.service || (sudo journalctl -u fruits.service -n 20 && exit 1)
                '
                """
            }
        }

        stage('Deploy Java Backend') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ec2-user@${env.JAVA_IP} '
                    sudo yum install git maven java-17-amazon-corretto -y
                    rm -rf ~/fruits-veg_market
                    git clone ${env.APP_REPO} ~/fruits-veg_market
                    cd ~/fruits-veg_market/java
                    
                    mvn clean package -DskipTests
                    
                    cat <<EOF > /tmp/vegetables.service
[Unit]
Description=Spring Boot Vegetables Service
After=network.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
WorkingDirectory=/home/ec2-user/fruits-veg_market/java
ExecStart=/usr/bin/java -jar target/produce-app-0.0.1-SNAPSHOT.jar --server.port=${env.JAVA_PORT}
Restart=always

[Install]
WantedBy=multi-user.target
EOF
                    sudo mv /tmp/vegetables.service /etc/systemd/system/vegetables.service
                    sudo systemctl daemon-reload
                    sudo systemctl enable vegetables.service
                    sudo systemctl restart vegetables.service
                '
                """
            }
        }
        
        stage('Deploy Frontend (Nginx)') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${SSH_KEY} ec2-user@${env.WEB_IP} '
                    sudo yum install git nginx -y
                    sudo systemctl start nginx
                    sudo systemctl enable nginx
                    
                    rm -rf ~/fruits-veg_market
                    git clone ${env.APP_REPO} ~/fruits-veg_market
                    
                    cd ~/fruits-veg_market/web
                    # Use unique delimiters for sed to avoid IP/Port conflicts
                    sed -i "s|FRUIT_MACHINE|${env.PYTHON_IP}|g" index.html
                    sed -i "s|VEG_MACHINE|${env.JAVA_IP}|g" index.html
                    sed -i "s|9000|${env.PYTHON_PORT}|g" index.html
                    sed -i "s|8080|${env.JAVA_PORT}|g" index.html
                    
                    sudo rm -rf /usr/share/nginx/html/*
                    sudo cp index.html /usr/share/nginx/html/
                    
                    # Fix Permissions and SELinux for Amazon Linux 2023
                    sudo chown -R nginx:nginx /usr/share/nginx/html
                    sudo chmod -R 755 /usr/share/nginx/html
                    sudo chcon -Rt httpd_sys_content_t /usr/share/nginx/html || true
                    
                    sudo systemctl restart nginx
                '
                """
            }
        }
    }
    
    post {
        success {
            echo "URL: http://${env.WEB_IP}"
        }
        failure {
            echo "Deployment failed. Check the stage logs."
        }
    }
}
